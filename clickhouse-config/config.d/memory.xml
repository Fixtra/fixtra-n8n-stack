<?xml version="1.0"?>
<clickhouse>
    <!-- Memory limits for 8GB system with 3GB container limit -->
    <max_server_memory_usage_to_ram_ratio>0.85</max_server_memory_usage_to_ram_ratio>
    
    <!-- Cache sizes optimized for low memory -->
    <mark_cache_size>512000000</mark_cache_size>           <!-- 512MB instead of 5GB default -->
    <index_mark_cache_size>128000000</index_mark_cache_size> <!-- 128MB instead of default -->
    <uncompressed_cache_size>67108864</uncompressed_cache_size> <!-- 64MB instead of default -->
    
    <!-- Disable memory-heavy features -->
    <mlock_executable>false</mlock_executable>
    
    <!-- Connection and query limits -->
    <max_connections>32</max_connections>                   <!-- Reduced from default 4096 -->
    <max_concurrent_queries>4</max_concurrent_queries>      <!-- Reduced from default 100 -->
    
    <!-- Thread pool limits -->
    <max_thread_pool_size>1000</max_thread_pool_size>      <!-- Reduced from default -->
    
    <!-- Background processing -->
    <background_pool_size>2</background_pool_size>         <!-- 2 for 4 vCPU -->
    <background_schedule_pool_size>2</background_schedule_pool_size>
    <background_merges_mutations_concurrency_ratio>2</background_merges_mutations_concurrency_ratio>
    
    <!-- Merge operations -->
    <merge_tree>
        <max_bytes_to_merge_at_max_space_in_pool>1073741824</max_bytes_to_merge_at_max_space_in_pool> <!-- 1GB -->
        <merge_max_block_size>2048</merge_max_block_size>   <!-- Reduced from 8192 -->
        <number_of_free_entries_in_pool_to_lower_max_size_of_merge>0</number_of_free_entries_in_pool_to_lower_max_size_of_merge>
    </merge_tree>
    
    <!-- Disable optional components -->
    <mysql_port remove="1" />
    <postgresql_port remove="1" />
    <query_thread_log remove="1" />
    <opentelemetry_span_log remove="1" />
    <processors_profile_log remove="1" />
</clickhouse>